<?xml version='1.0' standalone='yes'?>
<!DOCTYPE PLUGIN [
<!ENTITY name      "activestreams">
<!ENTITY author    "gthrift">
<!ENTITY version   "2026.02.05-beta2">
<!ENTITY launch    "Settings/ActiveStreamsSettings">
<!ENTITY branch    "2026.02.05">
<!ENTITY gitURL    "https://raw.githubusercontent.com/gthrift/activestreams-unraid/&branch;">
<!ENTITY emhttp    "/usr/local/emhttp/plugins/&name;">
<!ENTITY plgPATH   "/boot/config/plugins/&name;">
]>

<PLUGIN name="&name;"
        author="&author;"
        version="&version;"
        launch="&launch;"
        pluginURL="&gitURL;/activestreams_test.plg"
        support="https://forums.unraid.net/topic/196336-plugin-active-streams-display-your-active-embyjellyfinplex-streams-on-your-dashboard/"
        project="https://github.com/gthrift/activestreams-unraid"
        readme="https://github.com/gthrift/activestreams-unraid#readme"
        IconFA="film"
        icon="streams.png"
        min="6.12.0">

<CHANGES>
###2026.02.05-beta1
- improved transcoding detail
- Hide transcoding when Plex stream is "direct play"

###2026.02.04
- Fixed CSS... maybe
- Rolled back scrolling stream name for now.

###2026.02.04-beta4
- Fixed CSS... maybe
- Rolled back scrolling stream name for now.

###2026.02.01
- Beta build for testing
- Now installs from pre-built archive (same as production)
- Includes SHA256 verification

###2026.01.08-TEST
- TEST VERSION: Downloads files directly from GitHub src/ directory
- Security improvements: Token encryption, CSRF protection, SSL verification
- DO NOT USE IN PRODUCTION

###2026.01.07
- Rename ActiveStreams.page to ActiveStreamsDashboard.page to resolve issue with Dynamix Active Streams
</CHANGES>

<OVERVIEW>
BETA VERSION - For testing new features before production release.

A plugin to create a dashboard widget that shows your active streams from Plex, Emby, and Jellyfin servers.

BETA TESTING:
1. This version downloads files directly from GitHub (no package build needed)
2. Files are pulled from the branch set in the "branch" entity
3. Change the branch entity to test different branches
4. Uninstall before installing production version

To install from a specific branch, change the branch entity in this .plg file,
or use this URL format:
https://raw.githubusercontent.com/gthrift/activestreams-unraid/BRANCH_NAME/activestreams_test.plg
</OVERVIEW>

<!-- ============================================ -->
<!-- PRE-INSTALL: Clean old files, create dirs    -->
<!-- ============================================ -->
<FILE Run="/bin/bash">
        <INLINE>
                echo "================================================"
                echo " Installing BETA version of Active Streams"
                echo " Version: &version;"
                echo " Branch: &branch;"
                echo "================================================"

                # Uninstall any existing .txz package from a previous package-based install
                if ls "&plgPATH;/"*.txz 1>/dev/null 2>/dev/null; then
                    echo "Removing old package-based install..."
                    removepkg "&plgPATH;/"*.txz 2>/dev/null
                    rm -f "&plgPATH;/"*.txz
                    rm -f "&plgPATH;/"*.md5
                    rm -f "&plgPATH;/"*.sha256
                fi

                # Remove old webUI files to prevent conflicts
                rm -rf "&emhttp;"

                # Recreate plugin directory
                mkdir -p "&emhttp;"

                # Create config directory
                mkdir -p "&plgPATH;"
        </INLINE>
</FILE>

<!-- ============================================ -->
<!-- INSTALL: Source files from src/              -->
<!-- ============================================ -->
<FILE Name="&emhttp;/activestreams_api.php">
    <URL>&gitURL;/src/activestreams_api.php</URL>
</FILE>

<FILE Name="&emhttp;/activestreams_servers.php">
    <URL>&gitURL;/src/activestreams_servers.php</URL>
</FILE>

<FILE Name="&emhttp;/ActiveStreamsDashboard.page">
    <URL>&gitURL;/src/ActiveStreamsDashboard.page</URL>
</FILE>

<FILE Name="&emhttp;/ActiveStreamsSettings.page">
    <URL>&gitURL;/src/ActiveStreamsSettings.page</URL>
</FILE>

<!-- ============================================ -->
<!-- INSTALL: Metadata files (icons)              -->
<!-- ============================================ -->
<FILE Name="&emhttp;/streams.png">
    <URL>&gitURL;/metadata/streams.png</URL>
</FILE>

<FILE Name="&emhttp;/plex.png">
    <URL>&gitURL;/metadata/plex.png</URL>
</FILE>

<FILE Name="&emhttp;/emby.png">
    <URL>&gitURL;/metadata/emby.png</URL>
</FILE>

<FILE Name="&emhttp;/jellyfin.png">
    <URL>&gitURL;/metadata/jellyfin.png</URL>
</FILE>

<FILE Run="/bin/bash">
        <INLINE>
                # Set Default Config if missing
                if [ ! -f "&plgPATH;/activestreams.cfg" ]; then
                    echo "POLL_INTERVAL='5'" > "&plgPATH;/activestreams.cfg"
                    echo "WIDGET_ICON='streams'" >> "&plgPATH;/activestreams.cfg"
                    echo "WIDGET_TITLE='Active Streams'" >> "&plgPATH;/activestreams.cfg"
                    echo "Created default config"
                fi

                # Create empty servers config if missing
                if [ ! -f "&plgPATH;/servers.json" ]; then
                    echo "[]" > "&plgPATH;/servers.json"
                    echo "Created empty servers.json"
                fi

                # Set restrictive permissions on files containing sensitive tokens
                chmod 600 "&plgPATH;/servers.json"

                echo ""
                echo "-----------------------------------------------------------"
                echo " BETA version of &name; has been installed."
                echo " Version: &version;"
                echo ""
                echo " Config directory: &plgPATH;"
                echo ""
                echo " REMINDER: This is a BETA installation"
                echo " Uninstall before using production version"
                echo "-----------------------------------------------------------"
                echo ""
        </INLINE>
</FILE>

<!-- ============================================ -->
<!-- UNINSTALL                                    -->
<!-- ============================================ -->
<FILE Run="/bin/bash" Method="remove">
        <INLINE>
                echo "Uninstalling BETA version of &name;..."

                # Remove all plugin files from emhttp
                rm -rf "&emhttp;"

                # Remove any legacy package files from previous installs
                rm -f "&plgPATH;/"*.txz
                rm -f "&plgPATH;/"*.md5
                rm -f "&plgPATH;/"*.sha256

                # Configuration files are preserved for future reinstallation
                # Preserved: &plgPATH;/activestreams.cfg and &plgPATH;/servers.json

                echo ""
                echo "-----------------------------------------------------------"
                echo " BETA version of &name; has been uninstalled."
                echo " Your server configurations have been preserved at:"
                echo " &plgPATH;/"
                echo ""
                echo " To completely remove all settings, manually delete:"
                echo " &plgPATH;/activestreams.cfg"
                echo " &plgPATH;/servers.json"
                echo "-----------------------------------------------------------"
                echo ""
        </INLINE>
</FILE>

</PLUGIN>
