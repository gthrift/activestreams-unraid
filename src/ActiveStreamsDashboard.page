Menu="Dashboard"
Icon="streams.png"
---
<?php
    $plugin = "activestreams";
    $cfg = parse_ini_file("/boot/config/plugins/activestreams/activestreams.cfg");
    $poll_interval = isset($cfg['POLL_INTERVAL']) ? (int)$cfg['POLL_INTERVAL'] * 1000 : 5000;
    
    // Get widget customization
    $widget_icon = $cfg['WIDGET_ICON'] ?? 'streams';
    $widget_title = $cfg['WIDGET_TITLE'] ?? 'Active Streams';
    $enable_text_scroll = ($cfg['ENABLE_TEXT_SCROLL'] ?? '0') === '1';

    // Map icon to file
    $icon_file = "/plugins/activestreams/{$widget_icon}.png";
?>

<style>
    /* === CSS CUSTOM PROPERTIES === */
    :root {
        /* Spacing */
        --as-gap: 5px;
        --as-padding-row: 6px;
        --as-padding-header: 5px;
        --as-padding-mobile: 10px;

        /* Typography */
        --as-font-size-header: 11px;
        --as-font-size-time: 12px;
        --as-font-size-transcode: 10px;

        /* Colors - neutral defaults that work on most themes */
        --as-border-subtle: rgba(128, 128, 128, 0.15);
        --as-border-row: rgba(128, 128, 128, 0.1);
        --as-opacity-muted: 0.6;
        --as-opacity-transcode: 0.7;

        /* Icon */
        --as-icon-size: 32px;
    }

    /* Theme: Dark (black, dark) */
    .Theme--black:root,
    .Theme--dark:root {
        --as-border-subtle: rgba(255, 255, 255, 0.1);
        --as-border-row: rgba(255, 255, 255, 0.05);
    }

    /* Theme: Light (white, azure, gray) */
    .Theme--white:root,
    .Theme--azure:root,
    .Theme--gray:root {
        --as-border-subtle: rgba(0, 0, 0, 0.12);
        --as-border-row: rgba(0, 0, 0, 0.06);
    }

    /* === CONTAINER CONSTRAINTS === */
    tbody[title="<?=$widget_title?>"] {
        table-layout: fixed;
        width: 100%;
    }

    tbody[title="<?=$widget_title?>"] td {
        max-width: 100%;
        overflow: hidden;
    }

    #activestreams_streams {
        max-width: 100%;
        overflow: hidden;
        box-sizing: border-box;
    }

    /* === ICON === */
    .as-icon-img {
        width: var(--as-icon-size);
        height: var(--as-icon-size);
    }

    /* === GRID LAYOUT === */
    #activestreams_streams .as-row,
    #activestreams_streams .as-header-row,
    .as-header-row {
        display: grid;
        grid-template-columns: 20px minmax(0, 3.5fr) minmax(0, 2fr) minmax(0, 1.5fr) minmax(0, 2.5fr);
        align-items: center;
        width: 100%;
        max-width: 100%;
        min-width: 0;
        overflow: hidden;
        box-sizing: border-box;
        gap: var(--as-gap);
    }

    #activestreams_streams .as-row {
        border-bottom: none;
        padding: var(--as-padding-row) 0;
    }

    #activestreams_streams .as-row:last-child {
        border-bottom: none;
    }

    /* === TRANSCODE INDICATOR === */
    #activestreams_streams .as-transcode {
        font-size: var(--as-font-size-transcode);
        opacity: var(--as-opacity-transcode);
        margin-right: 4px;
    }

    /* === COLUMN BASE STYLES === */
    #activestreams_streams .as-server,
    #activestreams_streams .as-name,
    #activestreams_streams .as-device,
    #activestreams_streams .as-user,
    #activestreams_streams .as-time,
    .as-header-row .as-server,
    .as-header-row .as-name,
    .as-header-row .as-device,
    .as-header-row .as-user,
    .as-header-row .as-time {
        width: auto;
        min-width: 0;
        padding: 0;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
    }

    /* === INDIVIDUAL COLUMN STYLES === */
    #activestreams_streams .as-server,
    .as-header-row .as-server {
        text-align: center;
    }

    #activestreams_streams .as-name,
    .as-header-row .as-name {
        padding-right: var(--as-gap);
    }

    #activestreams_streams .as-device,
    .as-header-row .as-device,
    #activestreams_streams .as-user,
    .as-header-row .as-user {
        text-align: center;
    }

    #activestreams_streams .as-time,
    .as-header-row .as-time {
        text-align: center;
        font-family: monospace;
        font-size: var(--as-font-size-time);
    }

    /* === HEADER ROW === */
    .as-header-row {
        opacity: var(--as-opacity-muted);
        font-size: var(--as-font-size-header);
        text-transform: uppercase;
        padding-bottom: var(--as-padding-header);
        border-bottom: none;
        margin-bottom: var(--as-padding-header);
    }

    .as-header-row .as-server {
        visibility: hidden;
    }

    /* === LOADING STATE === */
    .as-loading-message {
        font-style: italic;
        text-align: center;
        padding-top: var(--as-padding-mobile);
    }

    /* === MOBILE (Max Width 600px) === */
    @media only screen and (max-width: 600px) {
        #activestreams_streams .as-row,
        #activestreams_streams .as-header-row,
        .as-header-row {
            grid-template-columns: minmax(0, 1fr) auto;
        }

        #activestreams_streams .as-server,
        #activestreams_streams .as-device,
        #activestreams_streams .as-user,
        .as-header-row .as-server,
        .as-header-row .as-device,
        .as-header-row .as-user {
            display: none;
        }

        #activestreams_streams .as-name,
        .as-header-row .as-name {
            padding-right: var(--as-padding-mobile);
        }

        #activestreams_streams .as-time,
        .as-header-row .as-time {
            padding-left: var(--as-padding-mobile);
        }
    }

    <?php if ($enable_text_scroll): ?>
    /* === TEXT SCROLLING ON HOVER === */
    @keyframes as-text-scroll {
        0%, 10% { transform: translateX(0); }
        90%, 100% { transform: translateX(var(--scroll-distance, -50%)); }
    }

    #activestreams_streams .as-scrollable {
        position: relative;
    }

    #activestreams_streams .as-scrollable .as-scroll-inner {
        display: inline-block;
        white-space: nowrap;
    }

    #activestreams_streams .as-scrollable:hover .as-scroll-inner.as-overflowing {
    animation: as-text-scroll var(--scroll-duration, 4s) linear infinite; 
    animation-delay: 0.3s;
    }

    /* Fade effect on edges for scrolling text */
    #activestreams_streams .as-scrollable.as-has-overflow::after {
        content: '';
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 20px;
        background: linear-gradient(to right, transparent, var(--background-color, #1c1b1b));
        pointer-events: none;
    }
    <?php endif; ?>
</style>

<?php
$mytiles[$plugin]['column1'] = <<<EOT
<tbody class="sortable" title="{$widget_title}">
  <tr>
    <td>
      <div class='tile-header' id='{$plugin}-dashboard-card'>
        <div class='tile-header-left'>
          <img src="{$icon_file}" class="as-icon-img icon">
          <div class='section'>
            <h3 class='tile-header-main' id='{$plugin}-dashboard-title'>
              {$widget_title}
            </h3>
            <span id="as_count_container"><span id="activestreams_count">0</span> _(Active Stream(s))_</span>
          </div>
        </div>
        <div class='tile-header-right'>
          <div class='tile-header-right-controls'>
            <a id="{$plugin}-settings-button" href="/Settings/ActiveStreamsSettings" title="_(Settings)_">
              <i class="fa fa-fw fa-cog control"></i>
            </a>
          </div>
        </div>
      </div>
    </td>
  </tr>
  <tr>
    <td>            
        <div class="as-header-row">
            <span class="as-server"></span>
            <span class="as-name">_(Name)_</span>
            <span class="as-device">_(Device)_</span>
            <span class="as-user">_(User)_</span>
            <span class="as-time">_(Progress)_</span>
        </div>
    </td>
  </tr>
  <tr>
    <td>
        <div id="activestreams_streams">
            <div id="as_retrieving">
                <p class="as-loading-message">_(Retrieving Data...)_</p>
            </div>
        </div>
    </td>
  </tr>
</tbody>
EOT;

// COMPATIBILITY BLOCK FOR UNRAID 7.2+
$isResponsiveWebgui = version_compare(parse_ini_file('/etc/unraid-version')['version'] ?? "", '7.2', '>=');
if ( ! $isResponsiveWebgui) {
    $mytiles[$plugin]["column1"] .= <<<EOT
        <script>
            \$(function() {
                \$('#{$plugin}-dashboard-title').replaceWith(function() {
                    return \$(this).text() + "<br>";
                });
                \$('#{$plugin}-settings-button').prependTo('#{$plugin}-dashboard-card');
            });
        </script>
EOT;
}
?>

<script>
    var asPollInterval = <?=$poll_interval;?>;
    var asEnableTextScroll = <?=$enable_text_scroll ? 'true' : 'false';?>;

    function setupTextScrolling() {
        if (!asEnableTextScroll) return;

        // Target columns that may overflow: name, device, user
        $('#activestreams_streams .as-name, #activestreams_streams .as-device, #activestreams_streams .as-user').each(function() {
            var $el = $(this);

            // Skip if already processed or is header
            if ($el.hasClass('as-scrollable') || $el.closest('.as-header-row').length) return;

            var content = $el.html();
            var title = $el.attr('title') || $el.text();

            // Wrap content in inner span for scrolling
            $el.addClass('as-scrollable');
            $el.html('<span class="as-scroll-inner">' + content + '</span>');
            $el.attr('title', title);

            // Check if text overflows after DOM update
            setTimeout(function() {
                var $inner = $el.find('.as-scroll-inner');
                var containerWidth = $el.width();
                var textWidth = $inner[0].scrollWidth;

                if (textWidth > containerWidth) {
                    $el.addClass('as-has-overflow');
                    $inner.addClass('as-overflowing');
                    var overflowAmount = textWidth - containerWidth + 20;
                    var scrollDistance = -overflowAmount;
                    $inner[0].style.setProperty('--scroll-distance', scrollDistance + 'px');
                    var pixelsPerSecond = 50; 
                    var movementTime = overflowAmount / pixelsPerSecond;
                    var totalDuration = movementTime / 0.8;
                    $inner[0].style.setProperty('--scroll-duration', totalDuration + 's');
                }
            }, 10);
        });
    }

    function updateActiveStreamsDashboard() {
        if ($("#activestreams_streams").is(":hover")) {
            return;
        }
        $.get("/plugins/activestreams/activestreams_api.php", function(data) {
            if (data) {
                $("#activestreams_streams").html(data);
                var count = $("#activestreams_streams .as-row").length;
                if(data.indexOf("No active streams") !== -1 ||
                   data.indexOf("No servers configured") !== -1 ||
                   data.indexOf("Connection failed") !== -1) {
                    count = 0;
                }
                $("#activestreams_count").text(count);

                setupTextScrolling();
            }
        });
    }

    $(function() {
        updateActiveStreamsDashboard();
        setInterval(updateActiveStreamsDashboard, asPollInterval);
    });
</script>
