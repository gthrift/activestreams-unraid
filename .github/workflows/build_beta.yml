name: Build Beta Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Beta version number (e.g., 2026.02.01-beta1)'
        required: true
      release_notes:
        description: 'Release notes (use \n for new lines)'
        required: false
        default: '- Beta build for testing'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build txz package
        id: build
        run: |
          VERSION="${{ github.event.inputs.version }}"
          PLUGIN_NAME="activestreams"

          echo "Building BETA ${PLUGIN_NAME} version ${VERSION}..."
          echo "Building from branch: ${GITHUB_REF_NAME}"

          # Create directories
          mkdir -p archive
          TEMP_DIR=$(mktemp -d)
          PLUGIN_DIR="${TEMP_DIR}/usr/local/emhttp/plugins/${PLUGIN_NAME}"
          mkdir -p "${PLUGIN_DIR}"

          # --- COPY FILES ---
          cp -r -v src/* "${PLUGIN_DIR}/" 2>/dev/null || true
          cp -v metadata/*.png "${PLUGIN_DIR}/" 2>/dev/null || true

          # --- FIX PERMISSIONS ---
          find "${TEMP_DIR}" -type d -exec chmod 755 {} \;
          find "${TEMP_DIR}" -type f -exec chmod 644 {} \;

          # --- CLEANUP ---
          find "${TEMP_DIR}" -name "._*" -delete

          # --- VERIFICATION ---
          FILE_COUNT=$(find "${PLUGIN_DIR}" -type f | wc -l)
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "ERROR: No files were copied to ${PLUGIN_DIR}"
            exit 1
          fi

          # --- CREATE ARCHIVE ---
          ARCHIVE_NAME="${PLUGIN_NAME}-${VERSION}.txz"
          
          cd "${TEMP_DIR}"
          tar --owner=0 --group=0 -cJf "${GITHUB_WORKSPACE}/archive/${ARCHIVE_NAME}" .
          cd "${GITHUB_WORKSPACE}"

          # Generate SHA256
          SHA256_HASH=$(sha256sum "archive/${ARCHIVE_NAME}" | awk '{print $1}')
          echo "${SHA256_HASH}" > "archive/${PLUGIN_NAME}-${VERSION}.sha256"

          # Output env vars
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV
          echo "SHA256_HASH=${SHA256_HASH}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

          rm -rf "${TEMP_DIR}"

          echo "Beta archive created: archive/${ARCHIVE_NAME}"

      - name: Update test plg file
        run: |
          VERSION="${{ github.event.inputs.version }}"
          RELEASE_NOTES="${{ github.event.inputs.release_notes }}"

          # Update version and hash in plg file
          sed -i 's/<!ENTITY version[[:space:]]*"[^"]*"/<!ENTITY version   "'"${VERSION}"'"/' activestreams_test.plg
          sed -i 's/<!ENTITY sha256[[:space:]]*"[^"]*"/<!ENTITY sha256    "'"${SHA256_HASH}"'"/' activestreams_test.plg

          # Add release notes if provided
          if [ -n "${RELEASE_NOTES}" ]; then
            FORMATTED_NOTES=$(printf '%s' "${RELEASE_NOTES}" | sed 's/\\n/\n/g')
            TEMP_FILE=$(mktemp)
            printf '###%s\n%s\n\n' "${VERSION}" "${FORMATTED_NOTES}" > "${TEMP_FILE}"

            awk '
            /<CHANGES>/ {
                print
                while ((getline line < "'"${TEMP_FILE}"'") > 0) {
                    print line
                }
                close("'"${TEMP_FILE}"'")
                next
            }
            {print}
            ' activestreams_test.plg > activestreams_test.plg.tmp && mv activestreams_test.plg.tmp activestreams_test.plg
            rm "${TEMP_FILE}"
          fi

      - name: Commit and push to Current Branch
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

          git add archive/ activestreams_test.plg

          # Commit to the branch that triggered the workflow
          git diff --staged --quiet && echo "No changes to commit" || git commit -m "Build beta version ${{ github.event.inputs.version }}"
          
          echo "Pushing to ${GITHUB_REF_NAME}..."
          git push origin HEAD:${GITHUB_REF_NAME}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync beta files to Main
        # Only run if we aren't already on main
        if: github.ref_name != 'main'
        run: |
          echo "------------------------------------------------"
          echo "SYNCING BETA FILES TO MAIN BRANCH"
          echo "------------------------------------------------"
          
          # Fetch main to ensure we have the latest ref
          git fetch origin main

          # Checkout main
          git checkout main

          # Checkout specifically the NEW files from the source branch (origin/BRANCH_NAME)
          # We grab the new archive, the sha256 file, and the updated plg file
          echo "Pulling files from origin/${GITHUB_REF_NAME}..."
          git checkout origin/${GITHUB_REF_NAME} -- archive/ activestreams_test.plg

          # Stage the files on main
          git add archive/ activestreams_test.plg

          # Commit to main
          git diff --staged --quiet && echo "No changes to commit to main" || git commit -m "Sync beta ${{ github.event.inputs.version }} from ${GITHUB_REF_NAME}"

          echo "Pushing to main..."
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo ""
          echo "==========================================="
          echo " BETA BUILD COMPLETE"
          echo "==========================================="
          echo ""
          echo " Version: ${VERSION}"
          echo " Archive: archive/${ARCHIVE_NAME}"
          echo " SHA256:  ${SHA256_HASH}"
          echo ""
          echo " Files updated on branches:" 
          echo "   1. ${GITHUB_REF_NAME}"
          echo "   2. main"
          echo ""
          echo " To install this beta on Unraid:"
          echo " 1. Go to Plugins > Install Plugin"
          echo " 2. Enter the following URL:"
          echo ""
          # We point the URL to main, as that is now the consistent source of truth for the test plg
          echo "    https://raw.githubusercontent.com/${{ github.repository }}/main/activestreams_test.plg"
          echo ""
          echo "==========================================="
